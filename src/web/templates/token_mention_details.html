{% extends 'layout.html' %}

{% block title %}{{ token.token_symbol }} 在 {{ channel.channel_name }} 的提及记录{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0" style="color: #ffffff; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">{{ token.token_symbol }} 在 {{ channel.channel_name }} 的提及记录</h5>
            <div>
                <span class="badge bg-light text-dark me-2">{{ token.chain }}</span>
                <a href="javascript:history.back()" class="btn btn-sm btn-light">
                    <i class="bi bi-arrow-left"></i> 返回
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6 class="border-bottom pb-2">代币信息</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span>代币符号:</span>
                        <span class="fw-bold">{{ token.token_symbol }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>合约地址:</span>
                        <span class="text-break">{{ token.contract }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="border-bottom pb-2">频道信息</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span>频道名称:</span>
                        <span class="fw-bold">{{ channel.channel_name }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>类型:</span>
                        <span>{% if channel.is_group %}群组{% else %}频道{% endif %}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>成员数:</span>
                        <span>{{ channel.member_count if channel.member_count else '未知' }}</span>
                    </div>
                </div>
            </div>
            
            <h5 class="border-bottom pb-2 mb-3">提及历史记录</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>提及时间</th>
                            <th>当时市值</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mention in mentions %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{% if mention.mention_time is string %}{{ mention.mention_time }}{% else %}{{ mention.mention_time.strftime('%Y-%m-%d %H:%M:%S') }}{% endif %}</td>
                            <td>{{ mention.market_cap_formatted }}</td>
                            <td>
                                <a href="/message/{{ mention.chain }}/{{ mention.message_id }}" class="btn btn-sm btn-outline-primary">
                                    查看原始消息
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center">暂无提及记录</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if mentions %}
            <div class="mt-4">
                <h5 class="border-bottom pb-2 mb-3">市值变化图表</h5>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="channelMarketCapChart"></canvas>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 加载Chart.js和Moment.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>

{% if mentions %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 准备数据
    const mentionData = [
        {% for mention in mentions %}
        {
            time: {% if mention.mention_time is string %}'{{ mention.mention_time }}'{% else %}'{{ mention.mention_time.isoformat() }}'{% endif %},
            market_cap: {{ mention.market_cap or 0 }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // 按时间排序
    mentionData.sort((a, b) => new Date(a.time) - new Date(b.time));
    
    // 绘制图表
    const ctx = document.getElementById('channelMarketCapChart').getContext('2d');
    const marketCapChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: '市值 (USD)',
                data: mentionData.map(item => ({
                    x: new Date(item.time),
                    y: item.market_cap
                })),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                fill: true,
                tension: 0.2,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'YYYY-MM-DD'
                        }
                    },
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: '市值 (USD)'
                    },
                    ticks: {
                        callback: function(value) {
                            // 格式化Y轴数值
                            if (value >= 1000000000) {
                                return '$' + (value / 1000000000).toFixed(2) + 'B';
                            } else if (value >= 1000000) {
                                return '$' + (value / 1000000).toFixed(2) + 'M';
                            } else if (value >= 1000) {
                                return '$' + (value / 1000).toFixed(2) + 'K';
                            } else {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            return moment(tooltipItems[0].parsed.x).format('YYYY-MM-DD HH:mm:ss');
                        },
                        label: function(context) {
                            const value = context.parsed.y;
                            let formattedValue = '';
                            if (value >= 1000000000) {
                                formattedValue = '$' + (value / 1000000000).toFixed(2) + 'B';
                            } else if (value >= 1000000) {
                                formattedValue = '$' + (value / 1000000).toFixed(2) + 'M';
                            } else if (value >= 1000) {
                                formattedValue = '$' + (value / 1000).toFixed(2) + 'K';
                            } else {
                                formattedValue = '$' + value.toFixed(2);
                            }
                            return '市值: ' + formattedValue;
                        }
                    }
                },
                title: {
                    display: true,
                    text: '{{ channel.channel_name }} 中 {{ token.token_symbol }} 市值变化'
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %} 