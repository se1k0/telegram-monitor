{% extends "layout.html" %}

{% block title %}Telegram 监控系统{% endblock %}

{% block head_extra %}
<style>
    /* 删除header-stats相关的CSS样式 */
    
    /* 代币表格样式优化 */
    .token-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .token-table thead th {
        background: var(--gray-100);
        color: var(--gray-700);
        font-weight: 600;
        padding: 1rem;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .token-table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid var(--gray-200) !important;
    }
    
    .token-table tbody tr:hover {
        background-color: var(--gray-100) !important;
        transform: translateY(-1px) scale(1.005);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        z-index: 1;
        position: relative;
    }
    
    .token-name {
        font-weight: 600;
        color: var(--gray-800);
    }
    
    .token-icon {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        object-fit: cover;
        margin-right: 12px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        background: white;
        border: 2px solid white !important;
    }
    
    .badge-chain {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        background-image: linear-gradient(to right, rgba(255,255,255,0.15), rgba(255,255,255,0));
    }
    
    /* 浮动操作按钮 */
    .floating-action-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 50px;
        height: 50px;
        border-radius: 25px;
        background: var(--secondary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 4px 20px rgba(118, 120, 237, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 100;
    }
    
    .floating-action-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(118, 120, 237, 0.4);
    }
    
    .floating-action-btn i {
        font-size: 1.5rem;
    }
    
    /* 搜索区域优化 */
    .search-container {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--gray-200);
    }

    .chain-filter-dropdown{
        z-index: 9999;
    }
    
    .search-box {
        position: relative;
    }
    
    .search-box input {
        padding-left: 3rem;
        height: 50px;
        border-radius: 10px;
        border: 1px solid var(--gray-300);
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.03);
        font-size: 1rem;
    }
    
    .search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-500);
        font-size: 1.2rem;
    }
    
    .search-box input:focus {
        box-shadow: 0 0 0 3px rgba(118, 120, 237, 0.2);
        border-color: var(--secondary-color);
    }
    
    .search-btn {
        height: 50px;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .chain-filter-btn {
        height: 50px;
        border-radius: 10px;
        background: white;
        border: 1px solid var(--gray-300);
        color: var(--gray-700);
        font-weight: 500;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.03);
    }
    
    .chain-filter-btn:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
    }
    
    /* 表格排序按钮 */
    .sort-btn {
        cursor: pointer;
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        margin-left: 5px;
        line-height: 0.5;
    }
    
    .sort-btn i {
        font-size: 0.6rem;
        color: var(--gray-400);
        transition: color 0.2s;
    }
    
    .sort-btn:hover i {
        color: var(--gray-700);
    }
    
    .sort-btn.active-asc i.bi-caret-up-fill,
    .sort-btn.active-desc i.bi-caret-down-fill {
        color: var(--secondary-color);
    }
    
    /* 正负值颜色 */
    .positive-change {
        color: var(--success-color);
        font-weight: 600;
    }
    
    .negative-change {
        color: var(--danger-color);
        font-weight: 600;
    }
    
    /* 加载指示器 */
    .loading-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }
    
    .loading-indicator .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(var(--primary-color-rgb), 0.1);
        border-radius: 50%;
        border-top-color: var(--secondary-color);
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* 社交链接样式 */
    .social-links {
        display: flex;
        gap: 8px;
    }
    
    .social-link {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-600);
        transition: all 0.2s;
    }
    
    .social-link:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
    }
    
    /* 切换视图按钮组 */
    .view-toggle-group {
        background: var(--gray-200);
        border-radius: 8px;
        padding: 3px;
        display: inline-flex;
    }
    
    .view-toggle-btn {
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--gray-600);
        border: none;
        background: transparent;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .view-toggle-btn.active {
        background: white;
        color: var(--primary-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .view-toggle-btn:hover:not(.active) {
        color: var(--gray-800);
    }
    
    /* 仪表盘卡片样式 */
    .dashboard-card {
        border-radius: 16px;
        background: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--gray-200);
        margin-bottom: 2rem;
        position: relative;
        z-index: 10; /* 设置较低的z-index，确保dropdown能够覆盖它 */
    }
    
    .dashboard-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .dashboard-card-title {
        font-weight: 600;
        margin-bottom: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .dashboard-card-body {
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- 删除整个header-stats部分 -->
<div class="container">
    <!-- 搜索与过滤区域 -->
    <div class="search-container mb-4 animate__animated animate__fadeInUp">
        <div class="row g-3">
            <div class="col-lg-8">
                <form class="d-flex" method="GET" action="/">
                    {% if chain_filter and chain_filter != 'all' %}
                    <input type="hidden" name="chain" value="{{ chain_filter }}">
                    {% endif %}
                    <div class="search-box flex-grow-1 me-2">
                        <i class="bi bi-search"></i>
                        <input class="form-control" type="search" placeholder="搜索代币/合约地址" aria-label="Search" name="search" value="{{ search_query }}">
                    </div>
                    <button class="btn btn-primary search-btn px-4" type="submit">
                        搜索
                    </button>
                </form>
            </div>
            <div class="col-lg-4 d-flex justify-content-end align-items-center">
                <div class="btn-group me-2" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary {% if chain_filter == 'all' %}active{% endif %}" onclick="window.location.href='/?chain=all{% if search_query %}&search={{ search_query }}{% endif %}'">全部</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary {% if chain_filter == 'eth' %}active{% endif %}" onclick="window.location.href='/?chain=eth{% if search_query %}&search={{ search_query }}{% endif %}'">ETH</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary {% if chain_filter == 'sol' %}active{% endif %}" onclick="window.location.href='/?chain=sol{% if search_query %}&search={{ search_query }}{% endif %}'">SOL</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary {% if chain_filter == 'bsc' %}active{% endif %}" onclick="window.location.href='/?chain=bsc{% if search_query %}&search={{ search_query }}{% endif %}'">BSC</button>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle chain-filter-btn" type="button" id="chainFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-funnel me-1"></i>
                        {{ chain_filter|upper if chain_filter != 'all' else '所有链' }}
                    </button>
                    <ul class="dropdown-menu chain-filter-dropdown shadow" aria-labelledby="chainFilterDropdown">
                        <li><a class="dropdown-item {% if chain_filter == 'all' %}active{% endif %}" href="/?chain=all{% if search_query %}&search={{ search_query }}{% endif %}">所有链</a></li>
                        <li><hr class="dropdown-divider"></li>
                        {% for chain in available_chains %}
                        <li><a class="dropdown-item {% if chain_filter == chain %}active{% endif %}" href="/?chain={{ chain }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ chain }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 如果URL中包含搜索参数，显示搜索结果的提示 -->
    {% if search_query %}
    <div class="alert alert-info mb-4 shadow-sm animate__animated animate__fadeIn" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-search me-2"></i>
            <span>搜索结果: <strong>"{{ search_query }}"</strong></span>
            <a href="/?chain={{ chain_filter if chain_filter else 'all' }}" class="btn btn-sm btn-outline-info ms-auto">清除搜索</a>
        </div>
    </div>
    {% endif %}

    <!-- 代币列表卡片 -->
    <div class="dashboard-card animate__animated animate__fadeInUp mb-5">
        <div class="dashboard-card-header">
            <h5 class="dashboard-card-title">
                <i class="bi bi-currency-exchange"></i>
                <span>代币监控 <span class="badge bg-secondary rounded-pill ms-2" id="token-counter">0</span></span>
            </h5>
        <div class="d-flex align-items-center">
                <div class="view-toggle-group me-3">
                    <button class="view-toggle-btn active" data-view="table">
                        <i class="bi bi-table me-1"></i>表格
                    </button>
                    <button class="view-toggle-btn" data-view="grid">
                        <i class="bi bi-grid-3x3-gap me-1"></i>网格
                    </button>
        </div>
                <button class="btn btn-sm btn-primary" id="refresh-button" onclick="refreshData()">
                    <i class="bi bi-arrow-repeat me-1"></i>刷新数据
                </button>
    </div>
        </div>
        <div class="dashboard-card-body p-0">
    <!-- 使用token_list.html模板展示代币列表 -->
    {% include 'partials/token_list.html' %}
        </div>
    </div>
</div>

<!-- 浮动操作按钮 -->
<div class="floating-action-btn" id="scrollTopBtn" style="display: none;" onclick="scrollToTop()">
    <i class="bi bi-arrow-up"></i>
</div>

<!-- 添加Token详情弹出层模板 -->
{% include 'partials/token_detail_modal.html' %}

<!-- 复制功能脚本 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 修复下拉菜单问题的更好方法
    const dropdown = document.querySelector('.chain-filter-dropdown');
    if (dropdown) {
        // 恢复Bootstrap下拉菜单功能
        const chainFilterBtn = document.getElementById('chainFilterDropdown');
        
        // 当下拉菜单显示时，确保其位于最顶层
        chainFilterBtn.addEventListener('shown.bs.dropdown', function() {
            // 将下拉菜单移到body的最后，确保它不会被其他元素的overflow:hidden影响
            document.body.appendChild(dropdown);
            
            // 调整位置和样式
            const btnRect = chainFilterBtn.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.zIndex = '9999';
            dropdown.style.top = btnRect.bottom + 'px';
            dropdown.style.left = btnRect.left + 'px';
            dropdown.style.minWidth = btnRect.width + 'px';
            
            // 添加Bootstrap下拉菜单的基本样式类
            dropdown.classList.add('dropdown-menu', 'show');
        });
        
        // 当下拉菜单隐藏时，恢复原位
        chainFilterBtn.addEventListener('hidden.bs.dropdown', function() {
            // 恢复原有DOM结构
            chainFilterBtn.parentNode.appendChild(dropdown);
            dropdown.style = '';
        });
    }
    
    // 初始化Token流式加载器
    if (typeof initTokenStreamLoader === 'function') {
        console.log("初始化Token流式加载器");
        initTokenStreamLoader();
    } else {
        console.error("找不到initTokenStreamLoader函数，token_stream_loader.js可能未正确加载");
    }
    
    // 窗口滚动处理
    window.addEventListener('scroll', function() {
        const scrollTopBtn = document.getElementById('scrollTopBtn');
        if (window.scrollY > 300) {
            scrollTopBtn.style.display = 'flex';
        } else {
            scrollTopBtn.style.display = 'none';
        }
    });
    
    // 视图切换功能
    const viewBtns = document.querySelectorAll('.view-toggle-btn');
    viewBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // 移除所有激活状态
            viewBtns.forEach(b => b.classList.remove('active'));
            // 激活当前按钮
            this.classList.add('active');
            
            // 这里可以添加实际的视图切换逻辑
            const viewType = this.getAttribute('data-view');
            console.log('切换到视图:', viewType);
            // TODO: 实现视图切换逻辑
        });
    });
});

// 滚动到顶部
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
            });
        }
    
// 刷新数据函数
function refreshData() {
    console.log('刷新数据...');
    
    // 显示加载指示器
    const refreshButton = document.getElementById('refresh-button');
    const originalContent = refreshButton.innerHTML;
    refreshButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span> 刷新中...';
    refreshButton.disabled = true;
    
    // 如果有token-stream-loader.js提供的刷新函数，使用它
    if (typeof reloadTokens === 'function') {
        reloadTokens().then(() => {
            refreshButton.innerHTML = originalContent;
            refreshButton.disabled = false;
            showToast('数据已更新', 'success');
        }).catch(error => {
            console.error('刷新数据出错:', error);
            refreshButton.innerHTML = originalContent;
            refreshButton.disabled = false;
            showToast('刷新数据出错', 'error');
        });
    } else {
        // 否则简单地重新加载页面
        window.location.reload();
    }
}
</script>
{% endblock %}

{% block scripts %}
<!-- 添加Chart.js库 -->
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
<!-- 添加Token详情弹出层脚本 -->
<script src="{{ url_for('static', filename='js/token_detail_modal.js') }}"></script>
<!-- 添加Token流式加载脚本 -->
<script src="{{ url_for('static', filename='js/token_stream_loader.js') }}"></script>

<script>
// 为社交链接图标添加悬停效果
document.addEventListener('DOMContentLoaded', function() {
    const socialLinks = document.querySelectorAll('.social-link');
    socialLinks.forEach(link => {
        link.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
        });
        link.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}