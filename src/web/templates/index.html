{% extends "layout.html" %}

{% block title %}Telegram 监控系统{% endblock %}

{% block head_extra %}
<style>
    .token-row {
        border: 1px solid var(--secondary-color);
        border-radius: 8px;
        margin-bottom: 1rem;
        background-color: var(--accent-color);
        box-shadow: var(--card-shadow);
        transition: all 0.2s;
    }
    .token-row:hover {
        box-shadow: 0 4px 8px rgba(66, 72, 116, 0.15);
    }
    .buys_1h{
        color:#4caf50 !important;
    }
    .sells_1h{
        color:#f44336 !important;
    }
    .token-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
    }
    .token-social-icon {
        width: 24px;
        height: 24px;
        margin-right: 5px;
        cursor: pointer;
    }
    .token-address {
        font-size: 0.8rem;
        color: var(--primary-light);
        cursor: pointer;
    }
    .token-address:hover {
        color: var(--primary-color);
    }
    .platform-icon {
        width: 20px;
        height: 20px;
        margin-right: 5px;
    }
    .tag {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        background-color: var(--secondary-color);
        color: var(--primary-color);
        margin-right: 5px;
    }
    .stat-label {
        font-size: 0.8rem;
        color: var(--primary-light);
    }
    .stat-value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-color);
    }
    .positive {
        color: var(--success-color);
    }
    .negative {
        color: var(--danger-color);
    }
    .search-container {
        background-color: var(--accent-color);
        border-radius: var(--card-border-radius);
        box-shadow: var(--card-shadow);
        padding: 15px;
        margin-bottom: 1.5rem;
    }
    .point-btn {
        cursor: pointer;
    }
    .point-btn:hover {
        color: var(--primary-light);
    }
    .table-header {
        background-color: var(--primary-color);
        color: var(--accent-color);
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
    }
    .chain-filter-dropdown {
        max-height: 200px;
        overflow-y: auto;
    }
    /* 涨跌幅颜色样式 */
    .positive-change {
        color: #4caf50;
    }
    .negative-change {
        color: #f44336;
    }
    .neutral-change {
        color: #757575;
    }
    /* 加载遮罩样式 */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* 灰色半透明背景 */
        z-index: 1050; /* 确保遮罩在所有内容之上 */
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .loading-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
    /* 添加新token的高亮动画 */
    @keyframes newTokenHighlight {
        0% { background-color: rgba(var(--primary-color-rgb), 0.3); }
        100% { background-color: var(--accent-color); }
    }
    .new-token-highlight {
        animation: newTokenHighlight 5s ease-out;
    }
    /* 添加无限滚动加载提示样式 */
    .infinite-scroll-loader {
        text-align: center;
        padding: 20px;
        display: none;
    }
    .infinite-scroll-loader .spinner-border {
        width: 2rem;
        height: 2rem;
    }
    /* Token名称和详情按钮样式 */
    .token-name-link {
        cursor: pointer;
        color: #0d6efd;
        text-decoration: none;
    }
    .token-name-link:hover {
        text-decoration: underline;
    }
    .token-detail-btn {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3" 
     data-has-more="{% if pagination and pagination.has_more %}true{% else %}false{% endif %}"
     data-next-page="{% if pagination and pagination.next_page %}{{ pagination.next_page }}{% else %}0{% endif %}">
    <!-- 搜索和筛选区域 -->
    <div class="search-container">
        <div class="row">
            <div class="col-md-8">
                <form class="d-flex" method="GET" action="/">
                    {% if chain_filter and chain_filter != 'all' %}
                    <input type="hidden" name="chain" value="{{ chain_filter }}">
                    {% endif %}
                    <input class="form-control me-2" type="search" placeholder="CA合约地址/代币Symbol" aria-label="Search" name="search" value="{{ search_query }}">
                    <button class="btn btn-primary" type="submit">搜索</button>
                </form>
            </div>
            <div class="col-md-4 d-flex justify-content-end align-items-center">
                <div class="dropdown me-2">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="chainFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        筛选链: {{ chain_filter|upper if chain_filter != 'all' else '所有链' }}
                    </button>
                    <ul class="dropdown-menu chain-filter-dropdown" aria-labelledby="chainFilterDropdown">
                        <li><a class="dropdown-item {% if chain_filter == 'all' %}active{% endif %}" href="/?chain=all{% if search_query %}&search={{ search_query }}{% endif %}">所有链</a></li>
                        {% for chain in available_chains %}
                        <li><a class="dropdown-item {% if chain_filter == chain %}active{% endif %}" href="/?chain={{ chain }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ chain }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
                <button id="refreshDataBtn" class="btn btn-warning" type="button">
                    <i class="bi bi-arrow-repeat"></i> 强制刷新数据
                </button>
            </div>
        </div>
    </div>

    <!-- 如果URL中包含搜索参数，显示搜索结果的提示 -->
    {% if search_query %}
    <div class="alert alert-info mb-3">
        搜索结果: "{{ search_query }}" 
        <a href="/?chain={{ chain_filter if chain_filter else 'all' }}" class="float-end">清除搜索</a>
    </div>
    {% endif %}

    <!-- 使用token_list.html模板展示代币列表 -->
    {% include 'partials/token_list.html' %}

    <!-- 如果没有数据，显示提示信息 -->
    {% if not tokens or tokens|length == 0 %}
    <div class="row">
        <div class="col-12 text-center py-5">
            <i class="bi bi-search display-1 text-muted"></i>
            <h3 class="mt-3">暂无代币数据</h3>
            <p class="text-muted">请使用搜索功能查找代币，或等待系统收集更多数据</p>
        </div>
    </div>
    {% endif %}

    <!-- 添加无限滚动加载提示 -->
    <div class="infinite-scroll-loader" id="infinite-scroll-loader">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <div class="mt-2">正在加载更多代币...</div>
    </div>
</div>

<!-- 添加Token详情弹出层模板 -->
{% include 'partials/token_detail_modal.html' %}
{% endblock %}

{% block scripts %}
<!-- 添加Chart.js库 -->
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
<!-- 添加Token详情弹出层脚本 -->
<script src="{{ url_for('static', filename='js/token_detail_modal.js') }}"></script>

<script>
// 定义全局变量，确保在所有函数中可用
let isLoading = false;
let hasMorePages = false;
let nextPage = 0;

// 防抖实现 - 限制同一代币短时间内多次点击
const debounceTimers = {};
const clickCooldowns = {};
const COOLDOWN_PERIOD = 1000; // 1秒冷却时间

function copyToClipboard(text, label) {
    navigator.clipboard.writeText(text).then(function() {
        alert(label + " 已复制到剪贴板");
    });
}

function debounce(func, wait, chainContract) {
    return function() {
        const context = this;
        const args = arguments;
        
        // 检查该代币是否在冷却期内
        const now = Date.now();
        if (clickCooldowns[chainContract] && (now - clickCooldowns[chainContract] < COOLDOWN_PERIOD)) {
            console.log(`点击过于频繁: ${chainContract}, 剩余冷却时间: ${Math.ceil((COOLDOWN_PERIOD - (now - clickCooldowns[chainContract])) / 1000)}秒`);
            // 显示冷却提示
            const cooldownMsg = document.createElement('div');
            cooldownMsg.className = 'alert alert-warning alert-dismissible fade show';
            cooldownMsg.style.position = 'fixed';
            cooldownMsg.style.top = '10px';
            cooldownMsg.style.right = '10px';
            cooldownMsg.style.zIndex = '9999';
            cooldownMsg.innerHTML = `
                <strong>请勿频繁点击!</strong> 请等待数据加载完成。
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(cooldownMsg);
            
            // 5秒后自动移除提示
            setTimeout(() => {
                cooldownMsg.remove();
            }, 5000);
            
            return;
        }
        
        clearTimeout(debounceTimers[chainContract]);
        debounceTimers[chainContract] = setTimeout(function() {
            func.apply(context, args);
            // 设置点击冷却时间
            clickCooldowns[chainContract] = Date.now();
        }, wait);
    };
}

// 页面加载完成后注册事件
document.addEventListener('DOMContentLoaded', function() {
    console.log("页面加载完成，初始化事件处理...");
    
    // 从DOM元素的data属性中获取分页信息
    const container = document.querySelector('.container-fluid.py-3');
    if (container) {
        hasMorePages = container.dataset.hasMore === 'true';
        nextPage = parseInt(container.dataset.nextPage || '0');
        console.log(`初始分页状态: hasMorePages=${hasMorePages}, nextPage=${nextPage}`);
    }
    
    // 添加滚动事件监听器，实现无限滚动
    window.addEventListener('scroll', function() {
        if (hasMorePages && !isLoading) {
            // 当用户滚动到距离底部200px时，加载更多内容
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
                console.log("触发无限滚动加载");
                loadMoreTokens();
            }
        }
    });

    // 添加强制刷新功能
    const refreshBtn = document.getElementById('refreshDataBtn');
    if (refreshBtn) {
        console.log("找到刷新按钮，添加点击事件");
        refreshBtn.addEventListener('click', function(event) {
            event.preventDefault();
            console.log("点击了刷新按钮");
            
            // 显示加载遮罩
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'refresh-loading-overlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <div>正在刷新所有数据，请稍候...</div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            // 获取当前选中的链和搜索内容
            const urlParams = new URLSearchParams(window.location.search);
            const chain = urlParams.get('chain');
            
            // 发送刷新请求
            const requestData = {};
            if (chain && chain !== 'all') {
                requestData.chain = chain;
            }
            
            console.log("发送刷新请求:", requestData);
            
            fetch('/api/refresh_tokens', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log("收到服务器响应:", response.status);
                return response.json();
            })
            .then(data => {
                // 移除加载遮罩
                document.getElementById('refresh-loading-overlay')?.remove();
                console.log("刷新请求响应数据:", data);
                
                if (data.success) {
                    // 显示成功消息
                    const successMsg = document.createElement('div');
                    successMsg.className = 'alert alert-success alert-dismissible fade show';
                    successMsg.style.position = 'fixed';
                    successMsg.style.top = '10px';
                    successMsg.style.right = '10px';
                    successMsg.style.zIndex = '9999';
                    successMsg.innerHTML = `
                        <strong>数据更新已启动!</strong> ${data.message}: ${data.count} 个代币正在从外部API获取最新数据。
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(successMsg);
                    
                    // 创建一个提示，告知用户30秒后刷新页面
                    const infoMsg = document.createElement('div');
                    infoMsg.className = 'alert alert-info alert-dismissible fade show';
                    infoMsg.style.position = 'fixed';
                    infoMsg.style.bottom = '10px';
                    infoMsg.style.right = '10px';
                    infoMsg.style.zIndex = '9999';
                    infoMsg.innerHTML = `
                        <strong>数据更新需要时间!</strong> 页面将在30秒后自动刷新以显示最新数据。
                        <div class="mt-2">
                            <div class="progress">
                                <div id="refresh-progress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(infoMsg);
                    
                    // 更新进度条
                    const progressBar = document.getElementById('refresh-progress');
                    const totalTime = 30; // 总时间30秒
                    let elapsed = 0;
                    
                    const progressInterval = setInterval(() => {
                        elapsed++;
                        const percentage = (elapsed / totalTime) * 100;
                        progressBar.style.width = `${percentage}%`;
                        
                        if (elapsed >= totalTime) {
                            clearInterval(progressInterval);
                        window.location.reload();
                        }
                    }, 1000);
                    
                    // 添加立即刷新按钮
                    const refreshNowBtn = document.createElement('button');
                    refreshNowBtn.className = 'btn btn-sm btn-primary mt-2';
                    refreshNowBtn.textContent = '立即刷新页面';
                    refreshNowBtn.onclick = function() {
                        clearInterval(progressInterval);
                        window.location.reload();
                    };
                    infoMsg.appendChild(refreshNowBtn);
                } else {
                    // 显示错误消息
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-danger alert-dismissible fade show';
                    errorMsg.style.position = 'fixed';
                    errorMsg.style.top = '10px';
                    errorMsg.style.right = '10px';
                    errorMsg.style.zIndex = '9999';
                    errorMsg.innerHTML = `
                        <strong>刷新失败!</strong> ${data.error || '未知错误'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(errorMsg);
                }
            })
            .catch(error => {
                // 移除加载遮罩
                document.getElementById('refresh-loading-overlay')?.remove();
                console.error("刷新请求出错:", error);
                
                // 显示错误消息
                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-danger alert-dismissible fade show';
                errorMsg.style.position = 'fixed';
                errorMsg.style.top = '10px';
                errorMsg.style.right = '10px';
                errorMsg.style.zIndex = '9999';
                errorMsg.innerHTML = `
                    <strong>刷新失败!</strong> ${error.message || '未知错误'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.body.appendChild(errorMsg);
            });
        });
                } else {
        console.warn("未找到刷新按钮!");
    }
});

// 加载更多token
function loadMoreTokens() {
    console.log(`开始加载更多代币: isLoading=${isLoading}, hasMorePages=${hasMorePages}, nextPage=${nextPage}`);
    
    if (isLoading || !hasMorePages) {
        console.log("忽略加载请求: 正在加载中或没有更多页面");
        return;
    }
    
    isLoading = true;
    
    // 确保加载提示元素存在
    let loader = document.getElementById('infinite-scroll-loader');
    
    // 如果加载提示元素不存在，创建一个新的
    if (!loader) {
        loader = document.createElement('div');
        loader.id = 'infinite-scroll-loader';
        loader.className = 'infinite-scroll-loader text-center my-3';
        loader.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <div class="mt-2">正在加载更多代币...</div>
        `;
        
        // 将加载提示添加到容器末尾
        const container = document.querySelector('.container-fluid.py-3');
        if (container) {
            container.appendChild(loader);
        }
    }
    
    // 显示加载提示
    if (loader) {
        loader.style.display = 'block';
    }
    
    // 从当前URL获取参数，而不是使用模板变量
    const urlParams = new URLSearchParams(window.location.search);
    const chain = urlParams.get('chain') || 'all';
    const search = urlParams.get('search') || '';
    
    // 构建请求URL
    const url = `/?page=${nextPage}&chain=${chain}&search=${search}&ajax=1`;
    console.log(`正在请求下一页数据: ${url}`);
    
    // 发送AJAX请求获取下一页数据
    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log("加载更多代币响应:", data);
            
            if (data.success) {
                // 添加新的代币行到表格中
                const tokensTable = document.querySelector('.table tbody');
                
                if (tokensTable && data.tokens && data.tokens.length > 0) {
                    console.log(`添加 ${data.tokens.length} 个新代币到列表`);
                
                data.tokens.forEach(token => {
                        // 创建新行
                        const row = document.createElement('tr');
                        
                        // 设置行样式和数据属性
                        row.className = token.is_profit ? 'table-profit' : 'table-loss';
                        row.dataset.chain = token.chain;
                        row.dataset.contract = token.contract;
                        row.dataset.id = token.id;
                        
                        // 生成行内容 - 确保匹配当前token_list.html中的列数和结构
                        row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                ${token.image_url ? 
                                `<img src="${token.image_url}" class="me-2 token-img" alt="${token.token_symbol}">` : 
                                `<div class="token-placeholder me-2">${token.token_symbol.charAt(0)}</div>`}
                                <div>
                                    <div class="fw-bold token-name-link" onclick="openTokenDetailModal('${token.chain}', '${token.contract}')">${token.token_symbol}</div>
                                    <div class="small text-muted">${token.contract.substring(0, 10)}...</div>
                                </div>
                            </div>
                        </td>
                        <td>${token.chain}</td>
                        <td>${token.market_cap_formatted}</td>
                        <td class="${token.change_pct_value > 0 ? 'text-success' : token.change_pct_value < 0 ? 'text-danger' : ''}">
                            ${token.change_percentage}
                        </td>
                        <td>${token.volume_1h_formatted || '$0'}</td>
                        <td>${token.buys_1h || 0}/${token.sells_1h || 0}</td>
                        <td>
                            ${token.holders_count ? token.holders_count : '<span class="text-muted">未知</span>'}
                        </td>
                        <td>${token.community_reach || 0}</td>
                        <td>${token.spread_count || 0}</td>
                        <td>${token.first_update_formatted}</td>
                        <td>
                            <div class="btn-group">
                                <a href="${getDexscreenerUrl(token.chain, token.contract)}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-graph-up"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-success like-btn" data-chain="${token.chain}" data-contract="${token.contract}">
                                    <i class="bi bi-heart"></i> <span class="like-count">${token.likes_count || 0}</span>
                                </button>
                                <button class="btn btn-sm btn-outline-info token-detail-btn" data-chain="${token.chain}" data-contract="${token.contract}">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                        </td>
                        `;
                        
                        // 添加到表格
                        tokensTable.appendChild(row);
                    });
                    
                    // 重新绑定新添加行的事件
                    document.querySelectorAll('.token-detail-btn:not([data-event-bound])').forEach(btn => {
                        btn.setAttribute('data-event-bound', 'true');
                        btn.addEventListener('click', function(event) {
                            event.preventDefault();
                            const chain = this.getAttribute('data-chain');
                            const contract = this.getAttribute('data-contract');
                            
                            if (chain && contract) {
                                openTokenDetailModal(chain, contract);
                            }
                        });
                    });
                    
                    // 更新分页状态
                    if (data.pagination) {
                        nextPage = data.pagination.next_page || 0;
                        hasMorePages = data.pagination.has_more || false;
                        console.log(`更新分页状态: nextPage=${nextPage}, hasMorePages=${hasMorePages}`);
                    } else {
                        console.warn("响应中缺少分页信息");
                    }
                } else {
                    console.warn(`没有代币或找不到表格: tokensTable=${!!tokensTable}, tokens=${data.tokens?.length || 0}`);
                    hasMorePages = false;
                }
            } else {
                console.error('加载更多代币失败:', data.error);
                
                // 显示错误提示
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.textContent = '加载更多代币失败: ' + (data.error || '未知错误');
                
                const container = document.querySelector('.container-fluid.py-3');
                if (container && loader) {
                    container.insertBefore(errorDiv, loader);
                    
                    // 5秒后自动移除错误提示
                    setTimeout(() => errorDiv.remove(), 5000);
                }
            }
        })
        .catch(error => {
            console.error('发生错误:', error);
            
            // 显示错误提示
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mt-3';
            errorDiv.textContent = '加载数据时出错: ' + error.message;
            
            const container = document.querySelector('.container-fluid.py-3');
            if (container && loader) {
                container.insertBefore(errorDiv, loader);
                
                // 5秒后自动移除错误提示
                setTimeout(() => errorDiv.remove(), 5000);
            }
        })
        .finally(() => {
            isLoading = false;
            // 隐藏加载提示
            if (loader) {
                // 不要移除元素，只隐藏它，以便下次使用
                loader.style.display = 'none';
            }
            console.log("完成加载更多代币");
        });
}

// 辅助函数 - 生成DexScreener URL
function getDexscreenerUrl(chain, contract) {
    if (chain === 'SOL') {
        return `https://dexscreener.com/solana/${contract}`;
    } else if (chain === 'ETH') {
        return `https://dexscreener.com/ethereum/${contract}`;
    } else if (chain === 'BSC') {
        return `https://dexscreener.com/bsc/${contract}`;
    } else {
        return `https://dexscreener.com/${chain.toLowerCase()}/${contract}`;
    }
}
</script>
{% endblock %}