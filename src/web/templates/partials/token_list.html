<div class="token-list-container">
    <!-- 加载状态提示 -->
    <div id="initial-loading" class="loading-indicator py-5">
        <div class="spinner"></div>
        <div class="mt-3 text-center">
            <h5 class="mb-2">正在加载代币数据</h5>
            <p class="text-muted small">首次加载可能需要几秒钟...</p>
        </div>
    </div>

    <!-- 暂无数据提示 -->
    <div id="no-tokens-message" class="py-5 text-center" style="display: none;">
        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
        <h5 class="mt-3">暂无代币数据</h5>
        <p class="text-muted">尝试更改筛选条件或添加新代币</p>
    </div>

    <!-- 代币表格 -->
    <div class="table-responsive" id="token-table-container" style="display: none;">
        <table class="token-table table align-middle mb-0">
            <thead>
                <tr>
                    <th class="text-nowrap">
                        <div class="d-flex align-items-center">
                            代币名称
                            <span class="sort-btn" data-sort="name">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap">
                        <div class="d-flex align-items-center">
                            链
                            <span class="sort-btn" data-sort="chain">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap d-none d-lg-table-cell">
                        <div class="d-flex align-items-center">
                            首次信号
                            <span class="sort-btn" data-sort="first_seen">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap d-none d-md-table-cell">
                        <div class="d-flex align-items-center">
                            市值
                            <span class="sort-btn" data-sort="market_cap">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap d-none d-lg-table-cell">
                        <div class="d-flex align-items-center">
                            涨跌幅
                            <span class="sort-btn" data-sort="change_24h">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap d-none d-lg-table-cell">
                        <div class="d-flex align-items-center">
                            1h交易额
                            <span class="sort-btn" data-sort="volume">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap d-none d-xl-table-cell text-center">
                        <div class="d-flex align-items-center justify-content-center">
                            1h交易数
                            <span class="sort-btn" data-sort="buys_sells">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap d-none d-xl-table-cell">
                        <div class="d-flex align-items-center">
                            持有者
                            <span class="sort-btn" data-sort="holders">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap d-none d-xl-table-cell">
                        <div class="d-flex align-items-center">
                            覆盖人数
                            <span class="sort-btn" data-sort="community_reach">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap d-none d-xl-table-cell">
                        <div class="d-flex align-items-center">
                            覆盖社群
                            <span class="sort-btn" data-sort="spread_count">
                                <i class="bi bi-caret-up-fill"></i>
                                <i class="bi bi-caret-down-fill"></i>
                            </span>
                        </div>
                    </th>
                    <th class="text-nowrap">信号详情</th>
                </tr>
            </thead>
            <tbody id="tokens-container">
                <!-- 代币将被动态添加到这里 -->
            </tbody>
        </table>
    </div>

    <!-- 加载更多指示器 -->
    <div id="load-more" class="loading-indicator py-4" style="display: none;">
        <div class="spinner"></div>
        <div class="mt-2 text-center">
            <p class="text-muted small mb-0">加载更多代币...</p>
        </div>
    </div>
</div>

<div id="new-tokens-notification-bar" style="display:none;"></div>

<style>
    /* 新添加的token行的高亮动画 */
    @keyframes highlightNew {
        0% { background-color: rgba(76, 175, 80, 0.2); }
        100% { background-color: transparent; }
    }
    .new-token-highlight {
        animation: highlightNew 5s ease-out;
    }

    .buy-count {
        color: #198754 !important; /* Bootstrap 5 的 text-success 绿色 */
        font-weight: 500;
    }
    .sell-count {
        color: #dc3545 !important; /* Bootstrap 5 的 text-danger 红色 */
        font-weight: 500;
    }

    .first-seen-badge {
        display: inline-block;
        padding: 0 6px;
        border-radius: 6px;
        font-size: 90%;
        font-weight: 500;
        margin-left: 2px;
    }
    .first-seen-now {
        background: #eaffea;
        color: #198754;
        border: 1px solid #b6eab6;
    }
    .first-seen-min {
        background: #fffbe6;
        color: #b8860b;
        border: 1px solid #ffe58f;
    }
    
    /* 市值和交易额的高亮样式 */
    .value-badge {
        display: inline-block;
        padding: 0 6px;
        border-radius: 6px;
        font-size: 90%;
        font-weight: 500;
    }
    .high-value {
        background: #fffbe6;
        color: #b8860b;
        border: 1px solid #ffe58f;
    }

    /* 高涨幅代币行高亮样式 */
    .high-change-highlight {
        background-color: #fffbe6 !important; /* 浅黄色背景 */
    }
    /* 提高优先级 */
    tr.token-row.high-change-highlight {
        background-color: #fffbe6 !important;
    }
    /* 确保高亮行的所有单元格都能显示高亮色 */
    tr.token-row.high-change-highlight > td {
        background-color: #fffbe6 !important;
    }

    /* 高交易额和高市值文字颜色 - 保留原有的颜色高亮，但不再使用 */
    .high-volume-text {
        color: #ffe600 !important; /* 浅黄色 */
    }
    
    .high-marketcap-text {
        color: #ffe600 !important; /* 浅黄色 */
    }

    #new-tokens-notification-bar {
        position: fixed;
        left: 50%;
        top: 90px; /* 距离顶部适当距离，避免遮挡搜索栏 */
        transform: translateX(-50%);
        z-index: 1000;
        background: #e9f5ff;
        border: 2px solid #2196f3;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(33, 150, 243, 0.15);
        padding: 12px 32px;
        font-weight: bold;
        color: #1976d2;
        min-width: 240px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        animation: notificationPulse 2s infinite;
    }

    @keyframes notificationPulse {
        0% { box-shadow: 0 4px 16px rgba(33, 150, 243, 0.15); }
        50% { box-shadow: 0 4px 24px rgba(33, 150, 243, 0.3); }
        100% { box-shadow: 0 4px 16px rgba(33, 150, 243, 0.15); }
    }

    #new-tokens-notification-bar:hover {
        background: #bbdefb;
        transform: translateX(-50%) scale(1.02);
        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.25);
    }

    #new-tokens-notification-bar i {
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .value-flash {
        animation: valueFlash 1.2s linear 2;
    }
    @keyframes valueFlash {
        0%   { color: inherit; opacity: 1; }
        20%  { color: #ff9800; opacity: 0.3; }
        40%  { color: #ff9800; opacity: 1; }
        60%  { color: #ff9800; opacity: 0.3; }
        80%  { color: #ff9800; opacity: 1; }
        100% { color: inherit; opacity: 1; }
    }
</style>

<!-- 代币行模板 -->
<template id="token-row-template">
    <tr class="token-row" data-id="TOKEN_ID" data-chain="TOKEN_CHAIN" data-contract="TOKEN_CONTRACT" data-token-symbol="TOKEN_SYMBOL">
        <!-- 代币名称列 -->
        <td>
            <div class="d-flex align-items-center">
                <img src="TOKEN_ICON" alt="TOKEN_NAME" class="token-icon" onerror="this.src='/static/img/default-token.png'">
                <div class="w-100">
                    <!-- 第一行：代币名称和社交媒体第一排 -->
                    <div class="d-flex align-items-center">
                        <div class="token-name">TOKEN_NAME <span class="token-symbol">TOKEN_SYMBOL</span></div>
                        <!-- 社交媒体第一排 - 由JS动态填充 -->
                        <div class="social-links-row1 ms-auto"></div>
                    </div>
                    <!-- 第二行：合约地址和社交媒体第二排 -->
                    <div class="d-flex align-items-center mt-1">
                        <div class="contract-address small text-muted d-flex align-items-center">
                            <span data-address="TOKEN_CONTRACT">TOKEN_CONTRACT_SHORT</span>
                            <button class="btn btn-sm btn-link text-muted p-0 ms-1 copy-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="复制地址" data-address="TOKEN_CONTRACT">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <!-- 社交媒体第二排 - 由JS动态填充 -->
                        <div class="social-links-row2 ms-auto"></div>
                    </div>
                </div>
            </div>
        </td>
        
        <!-- 链 -->
        <td>
            <span class="badge-chain CHAIN_CLASS">TOKEN_CHAIN</span>
        </td>
        
        <!-- 首次发现 -->
        <td class="d-none d-lg-table-cell text-nowrap">
            <div class="d-flex align-items-center">
                <i class="bi bi-clock me-1 text-muted"></i>
                <span class="small">TOKEN_FIRST_SEEN</span>
            </div>
        </td>
        
        <!-- 市值 -->
        <td class="d-none d-md-table-cell fw-medium">TOKEN_MARKET_CAP</td>
        
        <!-- 涨跌幅 -->
        <td class="d-none d-lg-table-cell TOKEN_CHANGE_CLASS">TOKEN_CHANGE_24H</td>
        
        <!-- 成交量 -->
        <td class="d-none d-lg-table-cell fw-medium">TOKEN_VOLUME</td>
        
        <!-- 买入/卖出 -->
        <td class="d-none d-xl-table-cell text-center">
            <div class="d-flex align-items-center justify-content-center">
                <span class="buy-count">TOKEN_BUYS</span>
                <span class="mx-1">/</span>
                <span class="sell-count">TOKEN_SELLS</span>
            </div>
        </td>
        
        <!-- 持有者 -->
        <td class="d-none d-xl-table-cell">TOKEN_HOLDERS</td>
        
        <!-- 社区覆盖 -->
        <td class="d-none d-xl-table-cell">TOKEN_COMMUNITY_REACH</td>
        
        <!-- 消息覆盖 -->
        <td class="d-none d-xl-table-cell">TOKEN_SPREAD_COUNT</td>
        
        <!-- 操作 -->
        <td>
            <div class="d-flex">
                <button class="btn btn-sm btn-primary view-token-btn" 
                        data-token-id="TOKEN_ID"
                        data-bs-toggle="modal" 
                        data-bs-target="#tokenDetailModal">
                    <i class="bi bi-box-arrow-up-right"></i>
                </button>
            </div>
        </td>
    </tr>
</template>

<script>
// 复制功能
document.addEventListener('click', function(e) {
    if(e.target.closest('.copy-btn')) {
        const button = e.target.closest('.copy-btn');
        const address = button.dataset.address;
        
        // 复制到剪贴板
        navigator.clipboard.writeText(address).then(function() {
            // 复制成功，显示提示
            button.innerHTML = '<i class="bi bi-check"></i>';
            setTimeout(() => {
                button.innerHTML = '<i class="bi bi-clipboard"></i>';
            }, 2000);
            
            // 显示提示
            showToast('地址已复制到剪贴板', 'success');
        }, function() {
            // 复制失败，显示错误
            showToast('复制失败，请手动复制', 'error');
        });
    }
});

// 创建提示容器
if (!document.querySelector('.toast-container')) {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(toastContainer);
}

// 显示提示信息
function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    
    // 创建toast元素
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    
    // 创建toast内容
    const toastBody = document.createElement('div');
    toastBody.className = 'd-flex';
    
    const toastContent = document.createElement('div');
    toastContent.className = 'toast-body';
    toastContent.textContent = message;
    
    const closeButton = document.createElement('button');
    closeButton.type = 'button';
    closeButton.className = 'btn-close btn-close-white me-2 m-auto';
    closeButton.setAttribute('data-bs-dismiss', 'toast');
    closeButton.setAttribute('aria-label', '关闭');
    
    // 组装toast
    toastBody.appendChild(toastContent);
    toastBody.appendChild(closeButton);
    toastEl.appendChild(toastBody);
    toastContainer.appendChild(toastEl);
    
    // 初始化Bootstrap Toast
    const toast = new bootstrap.Toast(toastEl, {
        delay: 3000
    });
    
    // 显示toast
    toast.show();
    
    // 在Toast隐藏后从DOM中移除元素
    toastEl.addEventListener('hidden.bs.toast', function () {
        toastEl.remove();
    });
}

// 初始化工具提示
function initTooltips() {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
}

// 页面加载完成后初始化工具提示
document.addEventListener('DOMContentLoaded', function() {
    initTooltips();
});

// // ========== 自动刷新频率限制 ========== //
// let autoRefreshCount = 0;
// const AUTO_REFRESH_LIMIT = 25;
// const AUTO_REFRESH_WINDOW = 60 * 1000; // 1分钟
// function tryIncreaseAutoRefreshCount() {
//     if (autoRefreshCount >= AUTO_REFRESH_LIMIT) return false;
//     autoRefreshCount++;
//     setTimeout(() => {
//         autoRefreshCount--;
//     }, AUTO_REFRESH_WINDOW);
//     return true;
// }

// // ========== 自动刷新可视区token（每次只刷新一个，且每条目1分钟一次） ========== //
// function isElementInViewport(el) {
//     const rect = el.getBoundingClientRect();
//     return (
//         rect.top < window.innerHeight &&
//         rect.bottom > 0
//     );
// }
// let autoRefreshQueue = [];
// function autoRefreshOneToken() {
//     if (autoRefreshQueue.length === 0) {
//         const now = Date.now();
//         autoRefreshQueue = Array.from(document.querySelectorAll('.token-row')).filter(row => {
//             if (!isElementInViewport(row)) return false;
//             const lastRefresh = parseInt(row.dataset.lastAutoRefresh || '0', 10);
//             return (now - lastRefresh >= 60 * 1000);
//         });
//     }
//     if (autoRefreshQueue.length > 0) {
//         if (!tryIncreaseAutoRefreshCount()) return; // 超过限制则不刷新
//         const row = autoRefreshQueue.shift();
//         refreshTokenData(row);
//         row.dataset.lastAutoRefresh = Date.now().toString();
//     }
// }
// document.addEventListener('DOMContentLoaded', function() {
//     const rows = document.querySelectorAll('.token-row');
//     const now = Date.now();
//     rows.forEach(row => {
//         row.dataset.lastAutoRefresh = now.toString();
//     });
// });
// setInterval(autoRefreshOneToken, 2000);
</script> 